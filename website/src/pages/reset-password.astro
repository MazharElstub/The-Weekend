---
import MainLayout from '../layouts/MainLayout.astro';

const pageTitle = 'Reset Password | The Weekend';
const description = 'Set a new password for your account in The Weekend app.';
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || '';
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || '';
const normalizeIOSDeepLink = (value: string | undefined): string => {
  const trimmed = (value || '').trim();
  if (!trimmed) return 'theweekend://';
  if (trimmed.startsWith('weekendplanner://')) {
    return `theweekend://${trimmed.slice('weekendplanner://'.length)}`;
  }
  return trimmed;
};

const normalizeAppStoreURL = (value: string | undefined): string => {
  const trimmed = (value || '').trim();
  const fallback = 'https://apps.apple.com/app/id6758899389';
  if (!trimmed) return fallback;
  if (
    trimmed === 'https://apps.apple.com' ||
    trimmed === 'https://apps.apple.com/' ||
    /^https:\/\/apps\.apple\.com\/[a-z]{2}\/?$/.test(trimmed)
  ) {
    return fallback;
  }
  return trimmed;
};

const iosDeepLink = normalizeIOSDeepLink(import.meta.env.PUBLIC_IOS_DEEPLINK);
const appStoreURL = normalizeAppStoreURL(import.meta.env.PUBLIC_APPSTORE_URL);
---

<MainLayout title={pageTitle} description={description}>
  <section class="panel">
    <p class="kicker">Password recovery</p>
    <h1>Set a new password</h1>
    <p>
      Opened from a reset email? Enter your new password below.
      If the link expired, request another reset from the iOS sign-in screen.
    </p>
  </section>

  <section class="section panel">
    <form id="reset-form" class="feedback-form" novalidate>
      <label>
        New password*
        <input id="new-password" name="new_password" type="password" autocomplete="new-password" minlength="6" required />
      </label>

      <label>
        Confirm new password*
        <input id="confirm-password" name="confirm_password" type="password" autocomplete="new-password" minlength="6" required />
      </label>

      <small>Minimum 6 characters. Use a unique password not reused elsewhere.</small>

      <div id="reset-state" class="reset-state" aria-live="polite"></div>

      <div class="cta-row">
        <button id="reset-submit" class="btn btn-primary" type="submit">Update password</button>
        <a class="btn btn-secondary" href={iosDeepLink}>Open app</a>
        <a class="btn btn-secondary" href={appStoreURL} target="_blank" rel="noreferrer noopener">App Store</a>
      </div>
    </form>
  </section>

  <div
    id="reset-config"
    data-supabase-url={supabaseUrl}
    data-supabase-anon-key={supabaseAnonKey}
    class="hidden"
  ></div>
  <script src="../scripts/reset-password.ts"></script>
</MainLayout>
